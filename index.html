<!DOCTYPE html>
<html>
    <head>
        <title>SL Experiment</title>
        <script src="https://unpkg.com/jspsych@8.0.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.2.1"></script>
        <script src="https://unpkg.com/@jspsych/plugin-survey@2.1.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-external-html@2.1.0"></script>
        <link
            href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css"
            rel="stylesheet"
            type="text/css"
        />
        <link
            rel="stylesheet"
            href="https://unpkg.com/@jspsych/plugin-survey@2.1.0/css/survey.css"
        />
        <!-- This is for data storage - please be sure to keep this script in all future updates to the code!! -->
        <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
    </head>

    <body>
        <audio id="audio" controls src="" style="display: none"></audio>
    </body>

    <script>
        // Set up audio helper functions
        const audio = document.getElementById('audio');

        // Add volume change listener to audio test to save ideal volume settings
        function addVolumeChangeEvent() {
            const audio_test = document.getElementById('audio_test');
            audio_test.addEventListener('volumechange', function () {
                audio.volume = audio_test.volume;
            });
        }

        function loadAudio(music) {
            audio.pause();

            if (music !== 'silence') {
                audio.src = `audio/${music}.mp3`;
                audio.play();
            }
        }

        // Initialize jsPsych
        var jsPsych = initJsPsych({
            show_progress_bar: true,
            override_safe_mode: true,
        });

        // PLEASE KEEP FOR ALL FUTURE ITERATIONS
        // Create a unique filename by combining a random string and a millisecond counter (to avoid duplicates)
        var random_id = jsPsych.randomization.randomID(10);
        const date = new Date();
        random_id = 'p' + random_id.toString();
        var file_id = random_id + '_' + date.getTime().toString();
        const filename = `${file_id}.csv`;
        //also store the random id for convenience
        jsPsych.data.addProperties({
            random_id: random_id,
        });

        // Create timeline
        const timeline = [];

        // Fullscreen
        const enter_fullscreen = {
            type: jsPsychFullscreen,
            fullscreen_mode: true,
        };
        timeline.push(enter_fullscreen);

        // Consent to participate
        const check_consent = function (elem) {
            if (document.getElementById('consent_checkbox').checked) {
                return true;
            } else {
                alert(
                    "If you wish to participate, you must check the box next to the statement 'I agree to participate in this study.'"
                );
                return false;
            }
            return false;
        };

        // Consent trial
        const consent_trial = {
            type: jsPsychExternalHtml,
            url: 'consent.html',
            cont_btn: 'start',
            check_fn: check_consent,
        };
        timeline.push(consent_trial);

        // Instructions trial
        const instructions = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
              <h2>Welcome!</h2>
              <p><strong>Please read the following instructions:</strong></p>
              <p> In this study, you will complete a baseline evaluation about yourself and your music habits, genre preferences, study routines, and motivation levels.</p>
              <p>Afterward, you will be shown a series of words in the center of your screen. Please pay close attention and try to remember as many words as possible.</p>
              <p>Next, you will be asked to recall the words you saw. Later, you will see a new list and repeat the process.</p>
              <p>At the end of the study, there will be a delayed recall test to assess your retention.</p>
              <p>Stay focused and do your best!`,
            choices: ['Continue'],
        };
        timeline.push(instructions);

        // Baseline evaluation
        const baseline_evaluation = {
            type: jsPsychSurvey,
            survey_json: {
                showQuestionNumbers: false,
                title: 'Baseline Evaluation',
                pages: [
                    {
                        elements: [
                            {
                                type: 'text',
                                name: 'baseline-age',
                                title: 'How old are you?',
                                maskType: 'numeric',
                                min: 0,
                                max: 110,
                                isRequired: true,
                            },
                            {
                                type: 'checkbox',
                                title: 'What is your race or ethnicity?',
                                description: 'Select all that apply.',
                                name: 'baseline-race',
                                choices: [
                                    'American Indian or Alaska Native',
                                    'Asian',
                                    'Black or African American',
                                    'Hispanic, Latino, or Spanish Origin',
                                    'Middle Eastern or North African',
                                    'Native Hawaiian or Other Pacific Islander',
                                    'White',
                                    'Multiethnic',
                                ],
                                showOtherItem: true,
                                showRefuseItem: true,
                                isRequired: true,
                            },
                        ],
                    },
                    {
                        elements: [
                            {
                                type: 'radiogroup',
                                title: 'How often do you listen to music while studying?',
                                name: 'baseline-listen-frequency',
                                choices: [
                                    'Always',
                                    'Often',
                                    'Sometimes',
                                    'Never',
                                ],
                                isRequired: true,
                            },
                            {
                                type: 'radiogroup',
                                title: 'How do you typically listen to music while studying?',
                                name: 'baseline-listening-device',
                                choices: [
                                    'Earbuds',
                                    'Over-ear headphones',
                                    'Speakers/Out loud',
                                    `I don't listen to music when studying`,
                                ],
                                isRequired: true,
                            },
                            {
                                type: 'checkbox',
                                title: 'What type(s) of music do you typically listen to while studying?',
                                name: 'baseline-music-type',
                                description: 'Select all that apply.',
                                choices: [
                                    'Classical',
                                    'Jazz',
                                    'Lo-fi / Chillhop',
                                    'Ambient / New Age',
                                    'Pop',
                                    'Rock',
                                    'R&B / Soul',
                                    'Hip-Hop / Rap',
                                    'Electronic / EDM',
                                    'Reggae',
                                    'Latin / Reggaeton',
                                    'K-Pop / J-Pop',
                                    'Nature Sounds / White Noise',
                                    'Podcasts / Spoken Word',
                                ],
                                showOtherItem: true,
                                showNoneItem: true,
                                isRequired: true,
                            },
                        ],
                    },
                    {
                        elements: [
                            {
                                type: 'radiogroup',
                                title: 'How many hours a week do you typically study?',
                                name: 'baseline-study-hours',
                                choices: [
                                    '0-1',
                                    '2-3',
                                    '4-5',
                                    '6-7',
                                    '8-9',
                                    '10+',
                                ],
                                isRequired: true,
                            },
                            {
                                type: 'checkbox',
                                title: 'Where do you usually study?',
                                name: 'baseline-study-location',
                                description: 'Select as many as you want.',
                                choices: ['Coffee shop', 'Home', 'Library'],
                                showOtherItem: true,
                                showNoneItem: true,
                                isRequired: true,
                            },
                            {
                                type: 'rating',
                                name: 'baseline-study-motivation',
                                title: 'How motivated do you typically feel while studying?',
                                minRateDescription: 'Not at all',
                                maxRateDescription: 'Extremely',
                                rateCount: 10,
                                rateMax: 10,
                                isRequired: true,
                            },
                        ],
                    },
                ],
            },
        };
        timeline.push(baseline_evaluation);

        // Transition to learning trials
        const baseline_transition = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
                <h2>Thank you!</h2>
                <p>Your baseline evaluation responses have been recorded.</p>
                <p><strong>You will now be taken to the learning task.</strong></p>
            `,
            choices: 'NO_KEYS',
            trial_duration: 3000,
        };
        timeline.push(baseline_transition);

        // Audio settings test trial
        const audio_test = {
            type: jsPsychHtmlButtonResponse,
            on_load: addVolumeChangeEvent,
            stimulus: `
                <h2>Adjust your volume</h2>
                <p>Before continuing, please adjust your volume using the audio player below.</p>
                <div><audio id="audio_test" controls controlsList = "noplaybackrate nodownload" src="audio/test.wav"></audio></div>
            `,
            choices: ['Continue'],
        };
        timeline.push(audio_test);

        function create_audio_start_trial(music) {
            const start_trial_audio = {
                type: jsPsychHtmlKeyboardResponse,
                choices: 'NO_KEYS',
                on_start: function () {
                    loadAudio(music);
                },
                stimulus: `<p>Starting trial with ${
                    (music !== 'silence' && `${music} music`) || 'silence'
                }.</p>
                  <p><strong>The trial will begin in 5 seconds.</strong></p>`,
                trial_duration: 5000,
            };

            return start_trial_audio;
        }

        // Define balanced word banks
        // prettier-ignore
        const word_banks = [
            [
                "apple", "table", "dog", "sun", "chair",
                "pencil", "river", "moon", "house", "flower",
                "bridge", "stone", "forest", "cloud", "pathway"
            ],
            [
                "phone", "candle", "ocean", "guitar", "mouse",
                "book", "lamp", "valley", "mountain", "car",
                "mirror", "radio", "harbor", "road", "journal"
            ],
            [
                "tree", "window", "cloud", "star", "computer",
                "train", "guitar", "desert", "cup", "door",
                "ceiling", "desk", "keyboard", "horizon", "stream"
            ]
        ];

        // Function to get random word bank and track options
        function get_word_bank() {
            if (word_banks.length === 0) {
                return console.warn('All words have been used!'); // Debugging
            }

            // Randomly select a word bank and remove
            let bank_index = Math.floor(Math.random() * word_banks.length);
            let selected_bank = word_banks.splice(bank_index, 1)[0];

            return selected_bank;
        }

        // Function to present words with fixation cross
        function create_word_trials(word_bank, label) {
            let trials = [];

            word_bank.forEach((word) => {
                // Fixation cross trial
                trials.push({
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: `<p style="font-size: 40px;">+</p>`,
                    choices: 'NO_KEYS',
                    trial_duration: 500, // Fixation cross shown for 500ms
                    data: { phase: label, type: 'fixation' },
                });

                // Word presentation trial
                trials.push({
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: `<p style="font-size: 32px;">${word}</p>`,
                    choices: 'NO_KEYS',
                    trial_duration: 1000, // Word displayed for 1 sec
                    data: { phase: label, type: 'word', word: word },
                });
            });

            return trials;
        }

        // Function to create distractor trials with math problems
        function create_distractor_trials() {
            const math_problems = [
                {
                    question: '8 Ã— 3 = ?',
                    choices: ['21', '24', '26', '28'],
                    correct_index: 1,
                },
                {
                    question: '15 - 9 = ?',
                    choices: ['5', '6', '7', '8'],
                    correct_index: 1,
                },
                {
                    question: '25 Ã· 5 = ?',
                    choices: ['4', '5', '6', '7'],
                    correct_index: 1,
                },
            ];

            // Generate trials
            const distractor_trials = [];
            math_problems.forEach((problem) => {
                distractor_trials.push({
                    type: jsPsychHtmlButtonResponse,
                    stimulus: `<p>${problem.question}</p>`,
                    choices: problem.choices,
                    data: {
                        phase: `math_distractor`,
                        correct_choice: problem.correct_index,
                    },
                    on_finish: function (data) {
                        data.correct = data.response === problem.correct_index;
                    },
                });
            });

            return distractor_trials;
        }

        // Creates a new recall trial
        function create_recall_trial(label) {
            const recall_trial = {
                type: jsPsychSurveyText,
                questions: [
                    {
                        prompt: 'List all the words you remember:',
                        rows: 5,
                        columns: 40,
                    },
                ],
                data: { phase: `immediate_recall_${label}` },
                on_finish: audio.pause(), // TODO: CHANGE LATER ðŸ‘ˆ
            };
            return recall_trial;
        }

        // Define music options and shuffle for randomization
        const music_options = ['instrumental', 'vocal', 'silence'];
        const trial_music = jsPsych.randomization.shuffle(music_options);

        // Generate a series of trials, distractors, and recalls for each music condition
        trial_music.forEach((track) => {
            // Load the appropriate audio
            const start_trial_audio = create_audio_start_trial(track);
            timeline.push(start_trial_audio);

            // Present words for the condition
            const word_bank = get_word_bank();
            timeline.push(...create_word_trials(word_bank, track));

            // Create distractor trials and add to the timeline
            const distractor_trials = create_distractor_trials();
            timeline.push(distractor_trials);

            // Create recall trial and add to the timeline
            const recall_trial = create_recall_trial(track);
            timeline.push(recall_trial);
        });

        // Reflection survey
        const reflection_survey = {
            type: jsPsychSurvey,
            survey_json: {
                showQuestionNumbers: false,
                title: 'Reflection Survey',
                pages: [
                    {
                        elements: [
                            {
                                type: 'rating',
                                name: 'reflect-study-mood',
                                title: 'How did you feel while completing this study?',
                                rateType: 'smileys',
                                rateCount: 10,
                                rateMax: 10,
                                scaleColorMode: 'colored',
                                isRequired: true,
                            },
                            {
                                type: 'rating',
                                name: 'reflect-study-motivation',
                                title: 'How motivated did you feel during this study?',
                                minRateDescription: 'Not at all',
                                maxRateDescription: 'Extremely',
                                rateCount: 10,
                                rateMax: 10,
                                isRequired: true,
                            },
                        ],
                    },
                    {
                        elements: [
                            {
                                type: 'radiogroup',
                                title: 'What listening device did you use during this study?',
                                name: 'reflect-listening-device',
                                choices: [
                                    'Earbuds',
                                    'Over-ear headphones',
                                    'Speakers/Out loud',
                                ],
                                isRequired: true,
                            },
                            {
                                type: 'radiogroup',
                                title: 'Have you heard the songs in this experiment before?',
                                name: 'reflect-music-familiarity',
                                choices: [
                                    'One of them',
                                    'Both of them',
                                    'Neither',
                                    `They sound familiar, but I'm unsure`,
                                ],
                                isRequired: true,
                            },
                            {
                                type: 'radiogroup',
                                title: 'How did you feel about the music played?',
                                name: 'reflect-music-opinion',
                                choices: [
                                    `I liked it, but I wouldn't use it for studying`,
                                    'I liked it and would use it for studying',
                                    `I didn't like the music used`,
                                ],
                                isRequired: true,
                            },
                            {
                                type: 'comment',
                                title: 'If you liked the music, did you like one track or both? Which one(s)?',
                                name: 'reflect-music-likes',
                            },
                        ],
                    },
                ],
            },
        };
        timeline.push(reflection_survey);

        // Save data
        const save_data = {
            type: jsPsychPipe,
            action: 'save',
            experiment_id: 'wCWH7aO7xiIT',
            filename: filename,
            data_string: () => jsPsych.data.get().csv(),
            version: '1.0.0', // Add the version field
            data: { phase: 'data_save' }, // Add the data field
        };

        timeline.push(save_data);

        // Debrief
        const debrief = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
              <h2>Thank you!</h2>
              <p>This experiment was designed to study if peoples motivation changes when learning</p>
              <p>and listening to different music.</p>`,
            choices: ['Finish'],
        };
        timeline.push(debrief);

        const exit_fullscreen = {
            type: jsPsychFullscreen,
            fullscreen_mode: false,
            delay_after: 0,
        };
        timeline.push(exit_fullscreen);

        // Start the experiment
        jsPsych.run(timeline);
    </script>
</html>
